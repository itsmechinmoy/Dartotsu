name: Dartotsu Unified Build & Release

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      build_targets:
        description: "Select platforms to build"
        required: true
        type: choice
        options: ["all", "android", "windows", "linux", "ios", "macos"]
      clean_build:
        description: "Clean build?"
        type: boolean
        default: false
      ping_discord:
        description: "Ping Discord role?"
        type: boolean
        default: false
      release_type:
        description: "Release type"
        type: choice
        options: ["alpha", "beta", "stable"]
        default: "alpha"

env:
  FLUTTER_VERSION: 3.35.7

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.set-platforms.outputs.platforms }}
      is_alpha: ${{ steps.config.outputs.is_alpha }}
      is_beta: ${{ steps.config.outputs.is_beta }}
      is_stable: ${{ steps.config.outputs.is_stable }}
      release_type: ${{ steps.config.outputs.release_type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release type
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ inputs.release_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            [[ "${{ github.ref_name }}" == *"beta"* ]] && TYPE="beta" || TYPE="stable"
          else
            TYPE="alpha"
          fi
          echo "release_type=$TYPE" >> $GITHUB_OUTPUT
          echo "is_alpha=$([[ $TYPE == 'alpha' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_beta=$([[ $TYPE == 'beta' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_stable=$([[ $TYPE == 'stable' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Set platforms to build
        id: set-platforms
        run: |
          PLATFORMS='[]'
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET="${{ inputs.build_targets }}"
            if [[ "$TARGET" == "all" ]]; then
              PLATFORMS='["android","windows","linux","ios","macos"]'
            elif [[ -n "$TARGET" ]]; then
              PLATFORMS="[\"$TARGET\"]"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            PLATFORMS='["android","windows","linux","ios","macos"]'
          elif [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            MESSAGE="${{ github.event.head_commit.message }}"
            if [[ "$MESSAGE" == *"[build.all]"* || "$MESSAGE" == *"[build]"* ]]; then
              PLATFORMS='["android","windows","linux","ios","macos"]'
            else
              TMP='['
              [[ "$MESSAGE" == *"[build.android]"* || "$MESSAGE" == *"[build.apk]"* ]] && TMP="${TMP}\"android\","
              [[ "$MESSAGE" == *"[build.windows]"* ]] && TMP="${TMP}\"windows\","
              [[ "$MESSAGE" == *"[build.linux]"* ]] && TMP="${TMP}\"linux\","
              [[ "$MESSAGE" == *"[build.ios]"* ]] && TMP="${TMP}\"ios\","
              [[ "$MESSAGE" == *"[build.macos]"* ]] && TMP="${TMP}\"macos\","
              PLATFORMS="${TMP%,}]"
            fi
          fi
          [[ "$PLATFORMS" == '[' ]] && PLATFORMS='[]'
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "DEBUG: platforms = $PLATFORMS"

  build:
    needs: prepare
    if: needs.prepare.outputs.platforms != '[]'
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.platforms) }}
    runs-on: >-
      ${{ matrix.platform == 'windows' && 'windows-latest' ||
          (matrix.platform == 'ios' || matrix.platform == 'macos') && 'macos-latest' ||
          'ubuntu-latest' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        id: setup-flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - uses: actions/cache@v4
        with:
          path: |
            ${{ steps.setup-flutter.outputs.pub-cache-path }}
            .dart_tool/
            build/
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: v2-${{ runner.os }}-${{ matrix.platform }}-${{ hashFiles('**/pubspec.lock','**/pubspec.yaml','**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: v2-${{ runner.os }}-${{ matrix.platform }}-

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: oracle
          java-version: 17

      - name: Setup cmake & ninja (Android)
        if: matrix.platform == 'android'
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "3.18.1"

      - name: Install Android deps
        if: matrix.platform == 'android'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build
          mkdir -p /usr/local/lib/android/sdk/cmake/3.18.1/bin
          sudo ln -s /usr/bin/ninja /usr/local/lib/android/sdk/cmake/3.18.1/bin/ninja

      - name: Setup Linux deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build cmake libgtk-3-dev webkit2gtk-4.1 libmpv-dev pkg-config fuse

      - name: Setup NuGet (Windows)
        if: matrix.platform == 'windows'
        uses: NuGet/setup-nuget@v2.0.1
        with:
          nuget-version: "latest"

      - name: Enable Windows desktop (Windows)
        if: matrix.platform == 'windows'
        run: flutter config --enable-windows-desktop

      - name: Setup secrets (Non-Windows)
        if: matrix.platform != 'windows'
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          APK_SIGN: ${{ secrets.APK_SIGN }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "FLUTTER_VERSION=${FLUTTER_VERSION_SECRET:-$FLUTTER_VERSION}" >> $GITHUB_ENV
          echo "SIMKL_SECRET=$SIMKL_SECRET" > .env
          echo "hash=$(git rev-parse --short HEAD)" >> .env
          if [[ "${{ matrix.platform }}" == "android" ]]; then
            mkdir -p android/app
            echo "$APK_SIGN" | base64 --decode > android/app/dartotsu.jks
            cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=dartotsu.jks
          EOF
          fi

      - name: Setup secrets (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          FLUTTER_VERSION_SECRET: ${{ secrets.FLUTTER_VERSION }}
          SIMKL_SECRET: ${{ secrets.SIMKL_SECRET }}
          PFX_FILE: ${{ secrets.PFX_FILE }}
          PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}
        run: |
          $flutterVersion = if ($env:FLUTTER_VERSION_SECRET) { $env:FLUTTER_VERSION_SECRET } else { "${{ env.FLUTTER_VERSION }}" }
          echo "FLUTTER_VERSION=$flutterVersion" >> $env:GITHUB_ENV
          echo "SIMKL_SECRET=$env:SIMKL_SECRET" > .env
          $hash = git rev-parse --short HEAD
          echo "hash=$hash" >> .env
          mkdir -p $env:USERPROFILE\certs
          [System.IO.File]::WriteAllBytes("$env:USERPROFILE\certs\Dartotsu.pfx", [Convert]::FromBase64String($env:PFX_FILE))

      - name: Configure Gradle (Android)
        if: matrix.platform == 'android'
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties

      - name: Build
        shell: bash
        run: |
          ${{ inputs.clean_build && 'flutter clean && ' || '' }}flutter pub get
          
          case "${{ matrix.platform }}" in
            android)
              flutter build apk --release --split-per-abi
              flutter build apk --release
              cd build/app/outputs/flutter-apk
              for f in app-*-release.apk; do
                abi=$(echo $f | sed 's/app-\(.*\)-release.apk/\1/')
                mv $f Dartotsu_Android_${abi}_${{ github.ref_name }}.apk
              done
              mv app-release.apk Dartotsu_Android_Universal_${{ github.ref_name }}.apk
              ;;
            windows)
              version=$(grep 'version:' pubspec.yaml | sed 's/version: \([0-9.]*\).*/\1/')
              echo "version=$version" >> $GITHUB_ENV
              signtool_path=$(powershell -Command "(Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\bin' -Directory | Where-Object { \$_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | Sort-Object Name -Descending | Select-Object -First 1).FullName + '\x64\signtool.exe'")
              dart run inno_bundle:build --sign-tool-params "\"$signtool_path\" sign /fd sha256 /f \"C:\Users\runneradmin\certs\Dartotsu.pfx\" /p \"${{ secrets.PFX_PASSWORD }}\" /tr http://timestamp.digicert.com /td sha256 /v \$f" --release
              ;;
            linux)
              flutter build linux --release
              cd build/linux/x64/release/bundle
              zip -r Dartotsu_LinuxZip_${{ github.ref_name }}.zip .
              ;;
            ios)
              flutter build ios --release --no-codesign
              cd build/ios/iphoneos
              rm -rf Payload && mkdir -p Payload && cp -R Runner.app Payload/
              zip -r Dartotsu-iOS-${{ github.ref_name }}.ipa Payload
              ;;
            macos)
              flutter build macos --release
              mkdir -p build/macos/Release
              hdiutil create -volname "Dartotsu" -srcfolder build/macos/Build/Products/Release/Dartotsu.app -ov -format UDZO build/macos/Release/Dartotsu-macos-${{ github.ref_name }}.dmg
              ;;
          esac

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-artifacts
          path: |
            ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/Dartotsu_Android_*.apk' || '' }}
            ${{ matrix.platform == 'windows' && 'build/windows/x64/installer/Release/Dartotsu-x86_64-*-Installer.exe' || '' }}
            ${{ matrix.platform == 'linux' && 'build/linux/x64/release/bundle/Dartotsu_LinuxZip_*.zip' || '' }}
            ${{ matrix.platform == 'ios' && 'build/ios/iphoneos/Dartotsu-iOS-*.ipa' || '' }}
            ${{ matrix.platform == 'macos' && 'build/macos/Release/Dartotsu-macos-*.dmg' || '' }}

  drive-alpha:
    needs: [prepare, build]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload Android arm64 to Drive
        if: contains(needs.prepare.outputs.platforms, 'android')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/android-artifacts/Dartotsu_Android_arm64-v8a_${{ github.ref_name }}.apk
          upload-name: Dartotsu_Android_arm64-v8a_${{ github.ref_name }}.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Upload Android armeabi to Drive
        if: contains(needs.prepare.outputs.platforms, 'android')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/android-artifacts/Dartotsu_Android_armeabi-v7a_${{ github.ref_name }}.apk
          upload-name: Dartotsu_Android_armeabi-v7a_${{ github.ref_name }}.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Upload Android x86_64 to Drive
        if: contains(needs.prepare.outputs.platforms, 'android')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/android-artifacts/Dartotsu_Android_x86_64_${{ github.ref_name }}.apk
          upload-name: Dartotsu_Android_x86_64_${{ github.ref_name }}.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Upload Android Universal to Drive
        if: contains(needs.prepare.outputs.platforms, 'android')
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: artifacts/android-artifacts/Dartotsu_Android_Universal_${{ github.ref_name }}.apk
          upload-name: Dartotsu.apk
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Find Windows installer
        if: contains(needs.prepare.outputs.platforms, 'windows')
        run: |
          INSTALLER=$(find artifacts/windows-artifacts -name "Dartotsu-x86_64-*-Installer.exe" 2>/dev/null | head -n1)
          if [ -f "$INSTALLER" ]; then
            echo "installer_path=$INSTALLER" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Upload Windows to Drive
        if: contains(needs.prepare.outputs.platforms, 'windows') && env.installer_path != ''
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: ${{ env.installer_path }}
          upload-name: Dartotsu_windows.exe
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Find Linux zip
        if: contains(needs.prepare.outputs.platforms, 'linux')
        run: |
          LINUX_ZIP=$(find artifacts/linux-artifacts -name "Dartotsu_LinuxZip_*.zip" 2>/dev/null | head -n1)
          if [ -f "$LINUX_ZIP" ]; then
            echo "linux_path=$LINUX_ZIP" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Upload Linux to Drive
        if: contains(needs.prepare.outputs.platforms, 'linux') && env.linux_path != ''
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: ${{ env.linux_path }}
          upload-name: Dartotsu_linux.zip
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Find iOS IPA
        if: contains(needs.prepare.outputs.platforms, 'ios')
        run: |
          IOS_IPA=$(find artifacts/ios-artifacts -name "Dartotsu-iOS-*.ipa" 2>/dev/null | head -n1)
          if [ -f "$IOS_IPA" ]; then
            echo "ios_path=$IOS_IPA" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Upload iOS to Drive
        if: contains(needs.prepare.outputs.platforms, 'ios') && env.ios_path != ''
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: ${{ env.ios_path }}
          upload-name: Dartotsu-iOS-${{ github.ref_name }}.ipa
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

      - name: Find macOS DMG
        if: contains(needs.prepare.outputs.platforms, 'macos')
        run: |
          MACOS_DMG=$(find artifacts/macos-artifacts -name "Dartotsu-macos-*.dmg" 2>/dev/null | head -n1)
          if [ -f "$MACOS_DMG" ]; then
            echo "macos_path=$MACOS_DMG" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Upload macOS to Drive
        if: contains(needs.prepare.outputs.platforms, 'macos') && env.macos_path != ''
        uses: hoatruongdev09/google-drive-file-upload-github-action@v1.1
        with:
          file-path: ${{ env.macos_path }}
          upload-name: Dartotsu-macos-${{ github.ref_name }}.dmg
          upload-to-folder-id: ${{ secrets.GOOGLE_FOLDER_MAIN }}
          service-account-json: "${{ secrets.GOOGLE_KEY }}"
          overrwrite: true
        continue-on-error: true

  release:
    needs: [prepare, build]
    if: needs.prepare.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate changelog
        run: |
          chmod +x scripts/generate_changelog.sh
          ./scripts/generate_changelog.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "artifacts/**/*"
          tag: ${{ github.ref_name }}
          bodyFile: CHANGELOG.md
          prerelease: ${{ needs.prepare.outputs.is_beta == 'true' }}
          allowUpdates: true

      - name: Commit changelog
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add CHANGELOG.md fastlane/metadata/android/en-US/changelogs/default.txt
          git commit -m "chore: update changelog for ${{ github.ref_name }}" || echo "No changes"
          git push origin HEAD:main || echo "Push failed (non-critical)"
        continue-on-error: true

  notify-alpha:
    needs: [prepare, build, drive-alpha]
    if: needs.prepare.outputs.is_alpha == 'true' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    outputs:
      commit_logs: ${{ steps.get_commits.outputs.commit_logs }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download last SHA
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: dartotsu-unified-workflow.yml
          name: last-sha
        continue-on-error: true

      - name: Get commits and send Discord notification
        id: get_commits
        run: |
          chmod +x scripts/discord_alpha_notify.sh
          ./scripts/discord_alpha_notify.sh
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          PING_DISCORD: ${{ inputs.ping_discord }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GOOGLE_FOLDER_ANDROID: ${{ secrets.GOOGLE_FOLDER_ANDROID }}
          GOOGLE_FOLDER_MAIN: ${{ secrets.GOOGLE_FOLDER_MAIN }}

      - name: Upload SHA artifact
        uses: actions/upload-artifact@v4
        with:
          name: last-sha
          path: last_sha.txt

  notify-release:
    needs: [prepare, build, release]
    if: needs.prepare.outputs.is_alpha == 'false' && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Send release notification
        run: |
          chmod +x scripts/discord_release_notify.sh
          ./scripts/discord_release_notify.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DISCORD_WEBHOOK_BETA_URL: ${{ secrets.DISCORD_WEBHOOK_BETA_URL }}
          DISCORD_WEBHOOK_RELEASE_URL: ${{ secrets.DISCORD_WEBHOOK_RELEASE_URL }}
          DISCORD_BETA_ROLE_PING: ${{ secrets.DISCORD_BETA_ROLE_PING }}
          DISCORD_STABLE_ROLE_PING: ${{ secrets.DISCORD_STABLE_ROLE_PING }}
          IS_BETA: ${{ needs.prepare.outputs.is_beta }}

  trigger-downloader:
    needs: [prepare, build, notify-alpha]
    if: >
      needs.prepare.outputs.is_alpha == 'true' &&
      !contains(needs.*.result, 'failure') &&
      github.repository == 'aayush2622/Dartotsu'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger downloader
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.DOWNLOADER_TRIGGER_TOKEN_SHEBY }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/grayankit/Dartotsu-Downloader/actions/workflows/main.yml/dispatches \
            -d '{
              "ref":"main",
              "inputs":{
                "commit_sha":"${{ github.sha }}",
                "commit_logs":"${{ needs.notify-alpha.outputs.commit_logs }}",
                "build_android":"success",
                "build_windows":"success",
                "build_linux":"success",
                "build_ios":"success",
                "build_macos":"success"
              }
            }'
